
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <title>Otterguessr | Ermine.at</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
			font-family: 'Roboto', sans-serif;
		}


        

        #street-view {
            height: 100%;
        }
		#launch-custom-mode {
    background-color: #ffffff; /* Green background */
    color: black; /* White text */
    padding: 15px 32px; /* Padding for size */
    text-align: center; /* Centered text */
    text-decoration: none; /* No underline */
    display: inline-block; /* Inline block display */
    font-size: 16px; /* Font size */
    margin: 4px 2px; /* Margin around the button */
    cursor: pointer; /* Cursor changes to pointer on hover */
    border-radius: 30px; /* Rounded corners */
}


    #map {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 400px; /* Initial width */
    height: 300px; /* Initial height */
    border: 2px solid black;
    border-radius: 30px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    z-index: 5;
    transition: all 0.3s ease; /* Smooth transition for size and position */
}

#map:hover {
    width: 800px; /* Increased width */
    height: 600px; /* Increased height */
    bottom: 20px; /* Adjust position to move up */
    right: 20px; /* Adjust position to move left */
}

		
		/* Hide the Street View Pegman */
.gm-svpc {
}

/* Hide the Map Type Control */
.gm-style-mtc {
    display: none !important;
}



/* Hide business POIs - Note: This might not be possible with CSS alone */


        #country-selector {
         position: relative; /* Changed to relative */
    z-index: 10;
    background: white;
    padding: 20px;
    margin-top: 20px; /* Space between the image and the window */
    border-radius: 30px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
}
		#reload-button {
            position: fixed;
        top: 160px; /* Adjust this if needed to clear the rounds window */
            left: 91.5%;
            transform: translateX(-50%);
            padding: 0px 3px;
            font-size: 16px;
            cursor: pointer;
			color: black !important;
            background-color: #ffffff;
            border: none;
            color: white;
            z-index: 5;
        }
		


#rounds-window {
    display: block;
    position: relative; /* Changed to relative */
    z-index: 10;
    background: white;
    padding: 20px;
    margin-top: 20px; /* Space between the image and the window */
    border-radius: 30px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
}
    #score-display {
        position: absolute;
        top: 90px; /* Adjusted top position */
        right: 20px;
        z-index: 5;
        background: white;
        padding: 10px;
        border-radius: 30px;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

#game-over {
    display: none;
    position: absolute;
    bottom: 20px; /* Position from the bottom */
    right: 20px; /* Position from the right */
    z-index: 50;
    background: white;
    padding: 20px;
    border-radius: 30px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    text-align: center;
}

#game-results {
    display: none;
    position: absolute;
    bottom: 20px; /* Position from the bottom */
    left: 20px; /* Position from the left */
    background: white;
    padding: 20px;
    border-radius: 30px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    z-index: 50; /* Ensure it's above other elements */
    max-height: 800px; /* Set a maximum height */
    overflow-y: auto; /* Enable scrolling if content overflows */
    max-width: 1000px; /* Set a width for the results */
}


    #street-view .gm-style .gm-fullscreen-control {
        display: none !important;
    }
  
.overlay {
    position: fixed; /* Stay in place */
    z-index: 10000; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    background-color: rgba(0,0,0,0.2); /* Black background with 0.2 opacity */
    display: flex; /* Use Flexbox to center the child */
    align-items: center; /* Align vertically at center */
    justify-content: center; /* Align horizontally at center */
    overflow-y: auto; /* Enable scroll if needed */
}

#custom-location-editor {
    background-color: #000000;
    padding: 20px;
    width: 80%; /* Could be more or less, depending on screen size */
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19); /* Optional: adds a subtle shadow for better visibility */
}
#loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: black;
    z-index: 10; /* High z-index to be on top */
    display: flex;
    flex-direction: column; /* Align children in a column */
    align-items: center;
    justify-content: center;
    padding: 10px; /* Add padding for spacing */
	overflow-y: auto;
}


        #game-end-screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: orange;
            z-index: 30;
            text-align: center;
            padding-top: 20%;
			opacity: 1;
        }
		
		 .styled-window {
            display: block;
            position: relative; /* Changed to relative */
            z-index: 10;
            background: white;
            padding: 20px;
            margin-top: 20px; /* Space between the image and the window */
            border-radius: 30px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }


#rounds-window, #country-selector, #game-over, #score-display {
    font-weight: bold; /* Make the font bold */
}
#rounds-input, 
button[onclick="startGame()"] {
    border-radius: 30px;
}

button[onclick="startGame()"] {
    background-color: black;  /* Set the background to black */
    color: white;             /* Set the text color to white */
    border-radius: 30px;      /* Rounded corners */
    transition: all 0.3s ease;/* Transition effect for smooth changes */
}

button[onclick="startGame()"]:hover {
    background-color: grey;  /* Background turns green on hover */
    transform: scale(0.97);    /* Make the button larger */
}

#play-again-button {
    background-color: black; /* Set the background to black */
	margin-top:5px;
    color: white;            /* Set the text color to white */
    border-radius: 30px;     /* Rounded corners */
    transition: all 0.3s ease;/* Transition effect for smooth changes */
}

#play-again-button:hover {
    background-color: grey; /* Background turns grey on hover */
    transform: scale(0.97); /* Make the button larger */
}

    .smaller-image {
            width: 20%; /* Adjust the width as needed */
            height: auto; /* Keeps the aspect ratio intact */
        }

#timer-settings {
    font-weight: bold;
}

        .styled-button {
            background-color: black;  /* Set the background to black */
            color: white;             /* Set the text color to white */
            border-radius: 30px;      /* Rounded corners */
            transition: all 0.3s ease;/* Transition effect for smooth changes */
        }

        .styled-button:hover {
            background-color: grey;  /* Background turns grey on hover */
            transform: scale(0.97);  /* Make the button slightly larger */
        }

    </style>
</head>
<body>
 <div id="loading-screen">
        <img src="static/otterguesserlogo.png" alt="OtterGuesser Logo" class="smaller-image">
<span style="color: white; margin-bottom: -20px"><h2>Classic mode - randomly generated locations</h2></span>
				<div id="rounds-window">
        <label for="rounds-input">Choose number of rounds (1-20):</label>
        <input type="number" id="rounds-input" min="1" max="20" value="5">
        <button onclick="startGame()">Start Game</button>
    </div>
	<div id="timer-settings" class="styled-window">
        <label for="timer-duration">Set timer duration (10s to 1200s):</label>
        <input type="number" style="border-radius: 30px;" id="timer-duration" min="10" max="600" value="120">
        <button onclick="setTimerDuration()" class="styled-button">Set Timer</button>
    </div>
	<select id="country-selector" onchange="updateCountry()">
        <option value="all">All Countries</option>
        <option value="us">United States</option>
        <option value="fr">France</option>
        <option value="de">Germany</option>
        <option value="it">Italy</option>
        <option value="jp">Japan</option>
        <option value="ru">Russia</option>
		<option value="at">Austria</option>
        <option value="de">Germany</option>
        <option value="pl">Poland</option>
        <option value="vienna">Wien :^)</option>
        <option value="belgrade">Beograd</option>
    </select>
	
<span style="color: white; margin-bottom: -20px"><h2>Custom mode - pregenerated locations from a file</h2></span>

<div class="styled-window">
    <input type="file" id="file-input" />
    <button onclick="loadGameFromFile()">Load Game from File</button>
</div>

	
<span style="color: white;">v28.11.2023b, f_otterguessr_a8</span>
<a href="https://ko-fi.com/otterable" target="_blank">
    <img height="36" style="border:0px;height:20px; display:none" src="static/donate.png" border="0" alt="Support on Ko-fi" />
</a>


<button id="launch-custom-mode" onclick="launchCustomGenerationMode()">Launch Custom Generation Mode</button>
<div id="custom-location-editor" class="overlay" style="display: none;">
    <span style="color: white; margin-bottom: -20px"><h4>Open browser console (F12) for instructions. Proper UI to be implemented later.</h4></span>
    <button onclick="saveLocation()">Save Current Location</button>
    <button id="download-custom-file" onclick="downloadCustomLocationsFile()" style="display: block;">Download Custom Locations File</button>
    <div id="custom-map" style="width: 1000px; height: 700px;"></div>
    <button onclick="toggleCustomGenerationMode()">Close</button>
</div>

    </div>
    <div id="game-end-screen">
        <p>Here shall be stats.</p>
    </div>
	
	<div id="loading-icon" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index:10000">
    <img src="static/wieselspin.gif" alt="Loading...">
	</div>

	
<div id="round-end-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 100; align-items: center; justify-content: center; flex-direction: column;">
    <div id="result-map" style="width: 1000px; height: 700px; border-radius: 30px;"></div>
    <p id="result-text" style="color: white; font-size: 20px; margin: 20px;">You clicked at XYZ coordinates. The correct coordinates were XYZ. These locations are XYZ kilometers away.</p>
<button id="round-end-button" onclick="nextRound()" style="padding: 10px 20px; font-size: 18px; cursor: pointer; border-radius: 30px;">Continue</button>
</div>

<div id="round-number-display" style="position: absolute; top: 20px; right: 20px; background: white; padding: 10px; border-radius: 30px; box-shadow: 0 0 5px rgba(0,0,0,0.3); z-index: 5;">
    Round: <span id="round-number">0</span> / <span id="total-rounds">0</span>
</div>

    
    <div id="timer-display" style="position: absolute; top: 20px; left: 20px; background: white; padding: 10px; border-radius: 30px; box-shadow: 0 0 5px rgba(0,0,0,0.3); z-index: 5;">
        Time left: <span id="timer">--:--</span>
    </div>

    <div id="street-view"></div>
    <div id="map"></div>
   
    <script>



        function initialize() {
            updateCountry();
			showRoundsWindow(); // Call this function to manage rounds window display

        }
		
		function loadGameFromFile() {
    var fileInput = document.getElementById('file-input');
    var file = fileInput.files[0];
    if (!file) {
        console.error('No file selected.');
        return;
    }

    var reader = new FileReader();
    reader.onload = function(e) {
        var contents = e.target.result;
        try {
            var data = JSON.parse(contents);
            setupGameFromFile(data);
        } catch (error) {
            console.error('Error parsing JSON:', error);
        }
    };
    reader.readAsText(file);
}

function setupGameFromFile(data) {
    if (data.totalRounds && data.roundLength && data.locations) {
        // Set total rounds and round length
        document.getElementById('rounds-input').value = data.totalRounds;
        document.getElementById('timer-duration').value = data.roundLength;
        timePerRound = data.roundLength;

        // Set locations for the game
        generatedLocations = data.locations.map(loc => new google.maps.LatLng(loc.lat, loc.lng));

        console.log(`File ${data.randomFileName} loaded. Timer is ${data.roundLength} seconds, there are ${data.totalRounds} rounds, the locations are:`);
        data.locations.forEach((loc, index) => console.log(`Round ${index + 1}: ${loc.lat}, ${loc.lng}`));

        startGame(); // Start the game with loaded settings
    } else {
        console.error('Invalid game data from file.');
    }
}

        var radii = [50, 100, 500];  // Search radii in km
        var radiusIndex = 0;
        var map;  // Declare map variable

        // Initial bounding boxes for all continents
        var allBoundingBoxes = [
            { minLat: 34, maxLat: 71, minLng: -24, maxLng: 40 },  // Europe
            { minLat: -35, maxLat: 35, minLng: -17, maxLng: 51 },  // Africa
            { minLat: 24, maxLat: 77, minLng: -169, maxLng: -50 },  // North America
            { minLat: -10, maxLat: 77, minLng: 29, maxLng: 169 },  // Asia + Australia
        ];

        var boundingBoxes = allBoundingBoxes;  // Default bounding boxes

        // Country-specific bounding boxes
        var countryBoundingBoxes = {
            us: { minLat: 24, maxLat: 49, minLng: -125, maxLng: -66 },
            fr: { minLat: 41, maxLat: 51, minLng: -5, maxLng: 8 },
            de: { minLat: 47, maxLat: 55, minLng: 5, maxLng: 15 },
            it: { minLat: 35, maxLat: 47, minLng: 6, maxLng: 19 },
            jp: { minLat: 30, maxLat: 45, minLng: 129, maxLng: 146 },
            ru: { minLat: 41, maxLat: 81, minLng: 19, maxLng: 169 },
			at: { minLat: 46.4, maxLat: 49, minLng: 9.5, maxLng: 17 },
            de: { minLat: 47, maxLat: 55, minLng: 5.5, maxLng: 15 },
            pl: { minLat: 49, maxLat: 54.5, minLng: 14, maxLng: 24 },
			vienna: { minLat: 48.15, maxLat: 48.25, minLng: 16.3, maxLng: 16.4 },
            belgrade: { minLat: 44.75, maxLat: 44.85, minLng: 20.35, maxLng: 20.55 }
        };
		
		function showRoundsWindow() {
            // Check if a game is in progress or not
            var gameInProgress = localStorage.getItem('gameInProgress');
            if(gameInProgress === 'true') {
                // If a game is in progress, hide the rounds window
                document.getElementById('rounds-window').style.display = 'none';
            } else {
                // If no game is in progress, show the rounds window
                document.getElementById('rounds-window').style.display = 'block';
            }
        }
		

function updateCountry() {
    var selectedCountry = document.getElementById('country-selector').value;
    localStorage.setItem('selectedCountry', selectedCountry);
    if (selectedCountry === 'all') {
        boundingBoxes = allBoundingBoxes;
    } else {
        boundingBoxes = [countryBoundingBoxes[selectedCountry]];
    }
    // Do NOT call fetchStreetView() here
}

        window.onload = function() {
    document.getElementById('loading-screen').style.display = 'flex';

    var selectedCountry = localStorage.getItem('selectedCountry');
    if (selectedCountry) {
        document.getElementById('country-selector').value = selectedCountry;
        updateCountry(); // Only update country selection, don't fetch Street View
    }
};
        function initialize() {
        }

        var radii = [50, 100, 500];  // Search radii in km
        var radiusIndex = 0;
        var map;  // Declare map variable

        // Define bounding boxes for the continents
        var boundingBoxes = [
            { minLat: 34, maxLat: 71, minLng: -24, maxLng: 40 },  // Europe
            { minLat: -35, maxLat: 35, minLng: -17, maxLng: 51 },  // Africa
            { minLat: 24, maxLat: 77, minLng: -169, maxLng: -50 },  // North America
            { minLat: -10, maxLat: 77, minLng: 29, maxLng: 169 },  // Asia + Australia
        ];

async function checkLandOrWater(latLng) {
    const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latLng.lat()}&lon=${latLng.lng()}`;
    const response = await fetch(nominatimUrl, {
        headers: { 'User-Agent': 'YourAppName/YourEmail' } // Replace with your app name and email
    });
    const data = await response.json();
    const selectedCountry = document.getElementById('country-selector').value;

    if (!data || !data.address || /ocean|sea|lake|arctic|pacific|norwegian|barents|mediterranean|gulf|aegan|tyrrhenian|atlantic/i.test(data.display_name)) {
        console.log('Generated coords found in the sea, moving to another location');
        return false;
    }

    if (selectedCountry !== 'all' && selectedCountry !== 'vienna' && selectedCountry !== 'belgrade') {
        const countryCode = data.address.country_code;
        if (countryCode !== selectedCountry) {
            console.log(`Generated coords found in ${countryCode}, moving to another location`);
            return false;
        }
    } else if (selectedCountry === 'vienna' && !data.display_name.includes('Vienna')) {
        console.log('Generated coords not found in Vienna, moving to another location');
        return false;
    } else if (selectedCountry === 'belgrade' && !data.display_name.includes('Belgrade')) {
        console.log('Generated coords not found in Belgrade, moving to another location');
        return false;
    }

    console.log(`New location is located in ${data.display_name}`);
    return true;
}


async function fetchCustomBoundary() {
    var townName = document.getElementById('custom-boundary-input').value;
    if (!townName) {
        console.error('Please enter a town name.');
        return;
    }
    
    try {
        var response = await fetch(`https://example.com/geojson-boundaries/${encodeURIComponent(townName)}`);
        if (!response.ok) {
            console.error('Failed to fetch GeoJSON boundaries:', response.statusText);
            return;
        }

        var geojsonData = await response.json();
        var bbox = geojsonData.bbox;
        if (!bbox || bbox.length !== 4) {
            console.error('Invalid GeoJSON bounding box data:', bbox);
            return;
        }

        boundingBoxes = [{
            minLat: bbox[1],
            maxLat: bbox[3],
            minLng: bbox[0],
            maxLng: bbox[2]
        }];
        fetchStreetView();  // Fetch street view for the custom boundary

    } catch (error) {
        console.error('Error fetching or processing GeoJSON boundaries:', error);
    }
}



async function fetchStreetView() {

    if (!isGameActive) {
        console.log('Game has ended. No new Street View will be fetched.');
        return; // Exit the function if the game is not active
    }

    // Use preloaded location if available
    if (generatedLocations && generatedLocations.length > currentRound) {
        let latLng = generatedLocations[currentRound];
        console.log(`Round ${currentRound + 1}: Generating location from file ${gameData.randomFileName}, location coordinates: ${latLng.lat()}, ${latLng.lng()}`);
        showStreetView(latLng);
        return;
    }
    console.log("Fetching Street View for round:", currentRound + 1);
    document.getElementById('loading-icon').style.display = 'block';  // Show loading icon
    console.log("Game loading, wieselspin added");
    var sv = new google.maps.StreetViewService();
    // Generate random coordinates within the defined bounding boxes
    var box = boundingBoxes[Math.floor(Math.random() * boundingBoxes.length)];
    var lat = Math.random() * (box.maxLat - box.minLat) + box.minLat;
    var lng = Math.random() * (box.maxLng - box.minLng) + box.minLng;
    var latLng = new google.maps.LatLng(lat, lng);

    var isLand = await checkLandOrWater(latLng);
    if (!isLand) {
        return fetchStreetView();
    }

    sv.getPanorama({
        location: latLng,
        radius: radii[radiusIndex] * 1000,  // Search radius around the random point
        source: google.maps.StreetViewSource.OUTDOOR // Focus on outdoor imagery
    }, function(data, status) {
        if (status === google.maps.StreetViewStatus.OK) {
            // Check if there are links (indicating navigable paths)
            if (data.links && data.links.length > 0) {
                processSVData(data, status);
            } else {
                // If no links, it's likely a static spot, fetch another location
                console.log('Static spot found, fetching a new location...');
                fetchStreetView();
            }
        } else {
            console.log('Street View not found, retrying...');
            fetchStreetView();
        }
    });
}
function showStreetView(latLng) {
    var sv = new google.maps.StreetViewService();
    sv.getPanorama({
        location: latLng,
        radius: 50,  // Adjust this radius if needed
        source: google.maps.StreetViewSource.OUTDOOR
    }, function(data, status) {
        if (status === google.maps.StreetViewStatus.OK) {
            var panorama = new google.maps.StreetViewPanorama(
                document.getElementById('street-view'), {
                    position: latLng,
                    pov: { heading: 34, pitch: 10 },
                    addressControl: false,
                    showRoadLabels: false
                });
            startTimer();
            initMap(data.location.latLng);
	
        } else {
            console.error('Street View not found for the given location.');
        }
    });
}

		
		var timer;
        var timePerRound = 120; // Default time per round in seconds

        function setTimerDuration() {
        var newDuration = parseInt(document.getElementById('timer-duration').value);
        if (newDuration >= 10 && newDuration <= 1200) {
            timePerRound = newDuration;
            console.log('Timer duration set to:', timePerRound); // Debugging
            alert('Timer duration set to ' + timePerRound + ' seconds.'); // Popup message
        } else {
            alert('Please enter a duration between 10 and 1200 seconds.');
        }
    }


        function startTimer() {
		    if (!isGameActive) {
        console.log('Game has ended. Timer will not start.');
        return; // Exit the function if the game is not active
    }
            var timeLeft = timePerRound;
            document.getElementById('timer').textContent = formatTime(timeLeft);
            timer = setInterval(function() {
                timeLeft--;
                document.getElementById('timer').textContent = formatTime(timeLeft);
                console.log('Timer updated:', formatTime(timeLeft)); // Debugging

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    console.log('Time is up! Moving to the next round.'); // Debugging
                    endRoundEarly();
                }
            }, 1000);
        }

        function formatTime(seconds) {
            var min = Math.floor(seconds / 60);
            var sec = seconds % 60;
            return min.toString().padStart(2, '0') + ':' + sec.toString().padStart(2, '0');
        }

        function endRoundEarly() {
            if (currentRound < totalRounds - 1) {
                currentRound++;
                updateRoundNumberDisplay();
                fetchStreetView();
            } else {
                endGame();
            }
            alert('You get 0 points for this round!');
            document.getElementById('score').textContent = totalScore;
        }

async function processSVData(data, status) {
    if (status === google.maps.StreetViewStatus.OK) {
        // Snap the panorama's coordinates to the nearest road.
        var response = await fetch(`https://roads.googleapis.com/v1/snapToRoads?path=${data.location.latLng.lat()},${data.location.latLng.lng()}&key=AIzaSyChOHZaT2T-YnRPTHdamiKhrNuELMGUAUY`);
        var roadData = await response.json();
        
        // Check if snappedPoints array has elements before trying to access its content
        if (roadData.snappedPoints && roadData.snappedPoints.length > 0) {
            // If the snapped coordinates are significantly different from the panorama's coordinates,
            // assume the panorama is not located on a road and fetch a new panorama.
var snappedLatLng = new google.maps.LatLng(roadData.snappedPoints[0].location.latitude, roadData.snappedPoints[0].location.longitude);
generatedLocations.push(snappedLatLng); // Store the generated location
if (google.maps.geometry.spherical.computeDistanceBetween(data.location.latLng, snappedLatLng) > 50) {  // Adjust the threshold as needed.
                console.log('Panorama not located on a road, fetching a new panorama...');
                return fetchStreetView();
            }

            // Otherwise, display the panorama and the map.
            var panorama = new google.maps.StreetViewPanorama(
                document.getElementById('street-view'),
                {
                    position: data.location.latLng,
                    pov: {
                        heading: 34,
                        pitch: 10
                    },
                    addressControl: false,
					showRoadLabels: false  // Hide road labels
                });
              // Start the timer when a new location is found
            console.log('Pair for location found at', data.location.latLng); // Debugging
            startTimer();
            initMap(data.location.latLng);
        } else {
            console.log('No roads nearby, fetching a new panorama...');
            return fetchStreetView();
        }
    } else {
        if (radiusIndex < radii.length - 1) {
            radiusIndex++;
            console.log(`Pair for location not found, finding the closest location within ${radii[radiusIndex]}km`);
            fetchStreetView();
        } else {
            console.error('Street View data not found for this location even after expanding the search radius. Retrying with a new location...');
            radiusIndex = 0;  // Reset radius index
            fetchStreetView();  // Generate a new random location
        }
    }
				gameData.locations.push({ // Save location data
                lat: data.location.latLng.lat(),
                lng: data.location.latLng.lng()
            });
			  document.getElementById('loading-icon').style.display = 'none';
			  console.log("Streetview found (location saved), wieselspin hidden."); // Debugging log
              console.log('Location saved:', gameData.locations[gameData.locations.length - 1]); // Debugging
        }



var currentRound = 0;
        var totalRounds = 0;
        var totalScore = 0;


function updateRoundNumberDisplay() {
    document.getElementById('round-number').textContent = currentRound + 1; // +1 because rounds start at 0
    document.getElementById('total-rounds').textContent = totalRounds;
}

var generatedLocations = [];
var userClickedLocations = [];
var isGameActive = false; // New variable to track the game state


       var gameData = {
            locations: [],
            randomFileName: '',
            totalRounds: 0,
            roundLength: 0 // New property to store round length
        };

        function generateRandomFileName() {
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            var fileName = '';
            for (var i = 0; i < 16; i++) {
                fileName += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return fileName + '.json';
        }

        function saveGameData() {
            var blob = new Blob([JSON.stringify(gameData)], { type: 'application/json' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = gameData.randomFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
		
		
function startGame() {
    isGameActive = true; // Set to true when a new game starts
    if (!generatedLocations || generatedLocations.length === 0) {
        generatedLocations = []; // Reset generated locations only if none are preloaded
        gameData.randomFileName = generateRandomFileName(); // Generate random file name
        console.log('Game started with random locations.');
    } else {
        console.log(`Game started with preloaded locations from file ${gameData.randomFileName}. No file will be generated.`);
        gameData.randomFileName = ''; // Clear the randomFileName to disable file generation
    }
    userClickedLocations = []; // Reset user clicked locations for new game
    totalRounds = document.getElementById('rounds-input').value; // Set totalRounds before updating the display
    currentRound = 0; // Reset currentRound to 0
    totalScore = 0;
    updateRoundNumberDisplay(); // Update the round number display
    document.getElementById('score').textContent = totalScore;
    document.getElementById('game-results').style.display = 'none';
    document.getElementById('game-results').innerHTML = ''; // Reset game results content
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('country-selector').style.display = 'none';
    document.getElementById('rounds-window').style.display = 'none';
    localStorage.setItem('gameInProgress', 'true');
    gameData.totalRounds = totalRounds; // Store total rounds
    gameData.roundLength = timePerRound; // Store round length
    console.log('Total rounds:', gameData.totalRounds, 'Round length:', gameData.roundLength); // Debugging
    fetchStreetView();
}


        function calculateScore(distance) {
       var score = 10000 * Math.exp(-0.000001 * distance);
    console.log("Calculated score: " + score + " for distance: " + distance);
    return Math.round(score);
}



async function endGame() {
    isGameActive = false; // Set to false when the game ends
    clearInterval(timer); // Clear the timer
    timer = null; // Reset the timer variable
    var resultsHtml = "<h3>Game Results</h3><ul>";

    // Update the map rendering part
    var map = new google.maps.Map(document.getElementById('gameover-map'), {
        center: { lat: 0, lng: 0 },
        zoom: 2
    });

    for (var i = 0; i < generatedLocations.length; i++) {
        var genLoc = generatedLocations[i];
        var userLoc = userClickedLocations[i];
        if (!genLoc || !userLoc) {
            console.error("Invalid location data at round", i + 1);
            continue; // Skip this round
        }

        var genLocName = await getLocationName(genLoc);
        var userLocName = await getLocationName(userLoc);
        var distance = calculateDistance(genLoc.lat(), genLoc.lng(), userLoc.lat(), userLoc.lng());

        resultsHtml += `<li>Round ${i + 1}: 
            ✔️ - <a href="https://www.google.com/maps/search/?api=1&query=${genLoc.lat()},${genLoc.lng()}" target="_blank">${genLocName}</a>, 
            ❌ - <a href="https://www.google.com/maps/search/?api=1&query=${userLoc.lat()},${userLoc.lng()}" target="_blank">${userLocName}</a>, 
            📏 - ${distance.toFixed(2)} km</li>`;
    

        // Add markers with circles on the map
        var userMarker = new google.maps.Marker({
            position: userLoc,
            map: map,
            label: {
                text: (i + 1).toString(), // Round number
                color: '#000000', // Text color
                fontWeight: 'bold', // Make text bold
                fontSize: '14px' // Text size
            },
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: "#FF0000",
                fillOpacity: 0.4,
                strokeWeight: 1
            }
        });

        var correctMarker = new google.maps.Marker({
            position: genLoc,
            map: map,
            label: {
                text: (i + 1).toString(), // Round number
                color: '#000000', // Text color
                fontWeight: 'bold', // Make text bold
                fontSize: '14px' // Text size
            },
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: "#00FF00",
                fillOpacity: 0.4,
                strokeWeight: 1
            }
        });
    }

   

   resultsHtml += "</ul>";
    document.getElementById('game-results').innerHTML = resultsHtml;
    document.getElementById('score-display').style.display = 'block';
    document.getElementById('game-over').style.display = 'block';
    document.getElementById('game-results').style.display = 'block';
    document.getElementById('total-points').textContent = totalScore;
    localStorage.setItem('gameInProgress', 'false');
    console.log('Game ended with total score: ' + totalScore);

    // Save game data to a file if started with randomly generated locations
	if (gameData.randomFileName) {
        gameData.locations = generatedLocations;
        saveGameData(); // Save the game data to a file
        console.log('Game data saved to file:', gameData.randomFileName); // Debugging
    } else {
        console.log('Game started with preloaded locations, no file will be downloaded.');
    }
	

    
	
   // Reset game data and generated locations
    generatedLocations = [];
    gameData = { locations: [], randomFileName: '', totalRounds: 0, roundLength: 0 };
    console.log('Game ended, data cache deleted.'); // Debugging message


}	
document.getElementById('game-end-screen').addEventListener('click', function() {
    this.style.display = 'none';
    document.getElementById('loading-screen').style.display = 'flex';
});

window.onload = function() {
    initialize();
    console.log('Page loaded and game initialized.');
};

function restartGame() {
    updateRoundNumberDisplay(); // Reset the round number display
    // Hide game-over and game-results screens
    document.getElementById('game-over').style.display = 'none';
    document.getElementById('game-results').style.display = 'none';
    document.getElementById('game-end-screen').style.display = 'none'; // Hide the orange overlay

    // Show the black overlay with the OtterGuesser logo
    document.getElementById('loading-screen').style.display = 'flex';

    // Make the "Start Game" button and country selector visible
    document.getElementById('rounds-window').style.display = 'block';
    document.getElementById('country-selector').style.display = 'block';

    localStorage.setItem('gameInProgress', 'false'); // Update game progress state
    showRoundsWindow(); // Ensure the rounds window is shown correctly
}


updateRoundNumberDisplay();



		
		        window.onload = initialize;


function initMap() {
    var fixedLatLng = new google.maps.LatLng(48.8566, 2.3522); // Example fixed coordinates (Paris, France)

    var mapOptions = {
        center: fixedLatLng,       // Fixed center for the map
        zoom: 2,                  // Fixed zoom level
        fullscreenControl: false,  // Keep the fullscreen control disabled
        zoomControl: false,        // Disable zoom controls
        streetViewControl: false,  // Disable Street View Pegman
        mapTypeControl: false,     // Disable map type (satellite/normal) control
        styles: [{                 // Style to hide business POIs (if needed)
            featureType: "poi.business",
            elementType: "labels",
            stylers: [{ visibility: "off" }]
        }]
    };

    map = new google.maps.Map(document.getElementById('map'), mapOptions);

    // Add a click event listener to the map
map.addListener('click', function(event) {
clearInterval(timer); // Stop the timer when the map is clicked
console.log('Map clicked, timer stopped.'); // Debugging
    if (currentRound > totalRounds - 1) {
        return;
    }

    var clickedLatLng = event.latLng;
    userClickedLocations.push(clickedLatLng); 
    var generatedLatLng = generatedLocations[currentRound];

    endRound(clickedLatLng, generatedLatLng);

    var score = calculateScore(google.maps.geometry.spherical.computeDistanceBetween(generatedLatLng, clickedLatLng));
    totalScore += score;
    document.getElementById('score').textContent = totalScore;

    if (currentRound === totalRounds - 1) {
        endGame();
    } else {
        currentRound++;
    }
});



}

		function calculateDistance(lat1, lng1, lat2, lng2) {
    var earthRadiusKm = 6371;

    var dLat = degreesToRadians(lat2-lat1);
    var dLng = degreesToRadians(lng2-lng1);

    lat1 = degreesToRadians(lat1);
    lat2 = degreesToRadians(lat2);

    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.sin(dLng/2) * Math.sin(dLng/2) * Math.cos(lat1) * Math.cos(lat2); 
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    return earthRadiusKm * c;
}

function degreesToRadians(degrees) {
    return degrees * Math.PI / 180;
}


function endRound(userLatLng, correctLatLng) {
    var distance = calculateDistance(userLatLng.lat(), userLatLng.lng(), correctLatLng.lat(), correctLatLng.lng());
    document.getElementById('result-text').innerText = `You clicked at (${userLatLng.lat().toFixed(5)}, ${userLatLng.lng().toFixed(5)}). The correct coordinates were (${correctLatLng.lat().toFixed(5)}, ${correctLatLng.lng().toFixed(5)}). These locations are ${Math.round(distance)} kilometers away.`;

    displayResultMap(userLatLng, correctLatLng);

    console.log("Current Round: " + currentRound);
    console.log("Total Rounds: " + totalRounds);

    var roundEndButton = document.getElementById('round-end-button');
      if (currentRound === totalRounds - 1) {
        // Last round - change the button text and function
        roundEndButton.innerText = 'Show Results';
        roundEndButton.onclick = function() {
            document.getElementById('round-end-overlay').style.display = 'none';
            endGame(); // Call endGame only when this button is clicked
        };
    } else {
        // Not the last round - keep the next round function
        roundEndButton.innerText = 'Next Round';
        roundEndButton.onclick = nextRound;
    }

    document.getElementById('round-end-overlay').style.display = 'flex';
}

function nextRound() {
    clearInterval(timer); // Clear the timer
    updateRoundNumberDisplay(); // Update the round number display
    if (currentRound >= totalRounds) {
        endGame();
        return;
    }
    document.getElementById('round-end-overlay').style.display = 'none';
    fetchStreetView();
}


function displayResultMap(userLatLng, correctLatLng) {
    var map = new google.maps.Map(document.getElementById('result-map'), {
        center: userLatLng,
        zoom: 2 // Set the zoom level to 1
    });

    new google.maps.Marker({
        position: userLatLng,
        map: map,
        label: {
            text: 'Your Otterguess', // Text for the label
            color: '#000000', // Text color
            fontWeight: 'bold', // Make text bold
            fontSize: '14px' // Text size
        },
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: "#FF0000",
            fillOpacity: 0.4,
            strokeWeight: 1
        }
    });

    new google.maps.Marker({
        position: correctLatLng,
        map: map,
        label: {
            text: 'Actual location', // Text for the label
            color: '#000000', // Text color
            fontWeight: 'bold', // Make text bold
            fontSize: '14px' // Text size
        },
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: "#00FF00",
            fillOpacity: 0.4,
            strokeWeight: 1
        }
    });
}

async function getLocationName(latLng) {
    var response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${latLng.lat()},${latLng.lng()}&key=AIzaSyChOHZaT2T-YnRPTHdamiKhrNuELMGUAUY`);
	var data = await response.json();
    
    if (data.results.length > 0) {
        var result = data.results[0];
        var addressComponents = result.address_components;
        var locality = addressComponents.find(c => c.types.includes('locality'))?.long_name;
        var adminArea = addressComponents.find(c => c.types.includes('administrative_area_level_1'))?.long_name;
        var country = addressComponents.find(c => c.types.includes('country'))?.long_name;

        var address = [locality, adminArea, country].filter(Boolean).join(", ");
        return address || result.formatted_address;
    } else {
        return "Unknown location";
    }
}


async function endRound(userLatLng, correctLatLng) {
    var userLocationName = await getLocationName(userLatLng);
    var correctLocationName = await getLocationName(correctLatLng);
    var distance = calculateDistance(userLatLng.lat(), userLatLng.lng(), correctLatLng.lat(), correctLatLng.lng());

		document.getElementById('result-text').innerHTML = `
        You clicked at <a href="https://www.google.com/maps/search/?api=1&query=${userLatLng.lat()},${userLatLng.lng()}" target="_blank" style="color: white; font-weight: bold;">${userLocationName}</a>. 
        The correct location was <a href="https://www.google.com/maps/search/?api=1&query=${correctLatLng.lat()},${correctLatLng.lng()}" target="_blank" style="color: white; font-weight: bold;">${correctLocationName}</a>. 
        These locations are ${Math.round(distance)} kilometers away.`;

    displayResultMap(userLatLng, correctLatLng);
    document.getElementById('round-end-overlay').style.display = 'flex';
}


		
    </script>
	<script>
    var customLocations = []; // Array to hold custom locations
    var customTotalRounds = 0; // Total number of rounds for custom mode
	var currentLatLng; // Global variable to store the current location
	var customMap; // This will hold the map instance

    // Function to launch the Custom Location Editor Mode
    function launchCustomGenerationMode() {
        document.getElementById('custom-location-editor').style.display = 'block'; // Show the map editor
        initCustomMap(); // Initialize the custom map with Street View enabled
    }


    // Initialize the custom map for location selection
function initCustomMap() {
    var mapOptions = {
        center: { lat: 48.8566, lng: 2.3522 },
        zoom: 3,
        streetViewControl: true,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    var customMap = new google.maps.Map(document.getElementById('custom-map'), mapOptions);

    // Update the current location when the map is clicked
    customMap.addListener('click', function(event) {
        currentLatLng = event.latLng;
        console.log('Use the stickman icon to switch to street view mode. Locations generated using Map Click will be invalid! BUG: Currently, the first street view will always result in a bug. I will fix this soon. // (Map Click):', currentLatLng.lat(), currentLatLng.lng());
    });

    // Listener for changes in Street View
    var streetView = customMap.getStreetView();
    google.maps.event.addListener(streetView, 'visible_changed', function() {
        if (streetView.getVisible()) {
            // Update the location when Street View is entered
            currentLatLng = streetView.getPosition();
            console.log('Current location SUCCESSFULLY updated. If you are satisfied with it, press "Save location". If not, continue browsing street view, until you are happy with the location. (Street View Entered):', currentLatLng.lat(), currentLatLng.lng());

            // Listener for changes in Street View position
            google.maps.event.addListener(streetView, 'position_changed', function() {
                currentLatLng = streetView.getPosition();
                console.log('Current location SUCCESSFULLY updated. If you are satisfied with it, press "Save location". If not, continue browsing street view, until you are happy with the location. (Street View Movement):', currentLatLng.lat(), currentLatLng.lng());
            });
        }
    });
}



function saveLocation() {
    if (currentLatLng) {
        customLocations.push(currentLatLng); // Save the current location to the array
        console.log('Location saved into the custom games file:', currentLatLng.lat(), currentLatLng.lng()); // Log the saved location

        // Create a marker for the saved location
        new google.maps.Marker({
            position: currentLatLng,
            map: customMap
        });

        // Reset currentLatLng
        currentLatLng = null;

        // Check if the number of selected locations equals the number of rounds
        if (customLocations.length === customTotalRounds) {
            document.getElementById('download-custom-file').style.display = 'block';
        }
    } else {
        console.log('No location selected to save.');
    }
}

    // Function to set the total number of rounds for custom mode
    function setCustomTotalRounds() {
        customTotalRounds = parseInt(document.getElementById('custom-rounds-input').value);
        console.log('Custom Total Rounds set to:', customTotalRounds); // Debugging
    }

    // Function to generate and download the custom locations file
function downloadCustomLocationsFile() {
    // Set the total number of rounds based on the number of saved locations
    customTotalRounds = customLocations.length;

    var customGameData = {
        locations: customLocations.map(loc => ({ lat: loc.lat(), lng: loc.lng() })),
        randomFileName: generateRandomFileName(), // Use the existing function to generate file name
        totalRounds: customTotalRounds.toString(),
        roundLength: 30 // Default round length, can be modified if needed
    };

    var blob = new Blob([JSON.stringify(customGameData)], { type: 'application/json' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = customGameData.randomFileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // Debugging: Log the file name and the number of rounds
    console.log(`Custom locations file ${customGameData.randomFileName} downloaded, containing ${customTotalRounds} rounds.`);

    // Reset customLocations array after download
    customLocations = [];
}

function launchCustomGenerationMode() {
    var editor = document.getElementById('custom-location-editor');
    if (editor.style.display === "block") {
        editor.style.display = "none";
    } else {
        editor.style.display = "block";
        initCustomMap(); // Initialize the custom map with Street View enabled
    }
}

function toggleCustomGenerationMode() {
    var editor = document.getElementById('custom-location-editor');
    editor.style.display = "none";
}

</script>

	<script>
	function reloadLocation() {
    radiusIndex = 0;
    fetchStreetView();
}
</script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChOHZaT2T-YnRPTHdamiKhrNuELMGUAUY&callback=initialize"></script>
	<button id="reload-button" style="display:none" onclick="reloadLocation()">reload</button>
  

    <div id="score-display">Points: <span id="score">0</span></div>

<div id="game-over">
    <p>Game over. You won <span id="total-points">0</span> points!</p>
    <div id="gameover-map" style="width: 800px; height: 600px; margin-top: 20px;"></div> <!-- New Map Container -->
    <button id="play-again-button" onclick="restartGame()">Play Again</button>

</div>
<div id="game-results"></div> <!-- New div for game results -->


</body>
</html>
