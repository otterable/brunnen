<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0000ff">
    <link rel="icon" href="/static/logo.png">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <title>BrunnenNavi</title>
     <style>
        body {
            background-color: #f5f1e4;
            font-family: Roboto, MaisonNeue, Segoe UI, Helvetica Neue, -apple-system, system-ui, BlinkMacSystemFont, Arial, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header-bar {
            background-color: #003056;
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 30px;
            cursor: pointer;
            margin: 10px;
        }
        .settings {
            display: flex;
            align-items: center;
        }
        .settings label {
            margin-left: 10px;
        }
        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px;
        }
        .btn-custom, .register-button-m {
            background-color: #003056;
            color: white;
            border: none;
            outline: none;
            box-shadow: none;
            border-radius: 30px;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            width: auto;
            box-sizing: border-box;
        }
        .register-button-m:hover {
            color: #f5f1e4 !important;
        }
        .dropdown-menu {
            background-color: #f5f1e4;
            border: none;
        }
        .dropdown-menu.show {
            display: block;
        }
        #map {
            flex: 1;
            margin: 0 10px;
            border-radius: 30px;
        }
    </style>
</head>
<body>
    <div class="header-bar" id="header-bar">
        <div id="closest-brunnen">Ihr Brunnen: <span id="distance"></span>‚úàÔ∏è, <span id="walking-distance"></span> zu ü¶∂üèª</div>
        <div id="address" style="font-size: smaller;"></div>
    </div>
    <div id="map"></div>
    <div class="button-container">
        <div class="dropdown">
            <button class="btn btn-custom register-button-m dropdown-toggle" type="button" id="moreDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Mehr
            </button>
            <div class="dropdown-menu" aria-labelledby="moreDropdown" x-placement="bottom-start" style="position: absolute; transform: translate3d(0px, 38px, 0px); top: 0px; left: 0px; will-change: transform;">
                <button id="installPWA" class="dropdown-item">App installieren</button>

                <button class="dropdown-item" onclick="window.open('https://donate.stripe.com/5kAg1z16R0oKdqg4ha', '_blank')">Spende</button>
            </div>
        </div>
        <button id="getLocation" class="btn btn-custom register-button-m">Fokussieren</button>
        <button id="findClosest" class="btn btn-custom register-button-m" disabled>‚õ≤ finden</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&libraries=geometry"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markerclustererplus/2.1.4/markerclusterer.min.js"></script>
    <script>
        let map;
        let userMarker;
        let userLocation;
        let closestBrunnenMarker;
        let selectedMarker = null;
        let brunnenData;
        let alwaysAskNavigate = true;
        let markerSize = 'medium';
        let userTrackingInterval;
        let polyline;
        let mapCenteredOnUser = false;
        let allMarkers = [];

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js').then(function() {
                console.log('Service Worker registered successfully.');
            }).catch(function(error) {
                console.log('Service Worker registration failed:', error);
            });
        }

        let deferredPrompt;
        const installBtn = document.getElementById('installPWA');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
            installBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    console.log('User response:', choiceResult.outcome);
                    deferredPrompt = null;
                });
            });
        });

       


        function initMap() {
            console.log('Initializing map...');
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: { lat: 48.2082, lng: 16.3738 },
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            console.log('Fetching brunnen data...');
            fetch('/api/brunnen')
                .then(response => response.json())
                .then(data => {
                    brunnenData = data;
                    updateMarkers();
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            console.log('User location obtained on page load.');
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            if (userMarker) {
                                userMarker.setMap(null);
                            }
                            userMarker = new google.maps.Marker({
                                position: userLocation,
                                map: map,
                                title: 'Ihr Standort',
                                icon: {
                                    url: 'static/man.png',
                                    scaledSize: new google.maps.Size(40, 40),
                                    anchor: new google.maps.Point(20, 20)
                                }
                            });
                            if (!mapCenteredOnUser) {
                                map.setCenter(userLocation);
                                map.setZoom(16);  // Zoom in on user location
                                mapCenteredOnUser = true;
                            }
                            document.getElementById('findClosest').disabled = false;
                            findClosestBrunnen(false, true);
                            startTrackingUserLocation();
                        }, () => {
                            console.log('Error in geolocation.');
                            alert('Geolocation is not supported by this browser or access is denied.');
                        });
                    }
                });
        }

        function createIcon(size, isFeatured) {
            let iconSize;
            switch(size) {
                case 'small':
                    iconSize = 40;
                    break;
                case 'medium':
                    iconSize = 60;
                    break;
                case 'big':
                    iconSize = 80;
                    break;
                default:
                    iconSize = 60;
            }

            const iconUrl = isFeatured ? 'static/mapicon_selected.png' : 'static/mapicon.png';
            console.log(`Creating icon: ${iconUrl}, size: ${iconSize}`);
            return {
                url: iconUrl,
                scaledSize: new google.maps.Size(iconSize, iconSize),
                anchor: new google.maps.Point(iconSize / 2, iconSize / 2)
            };
        }

        function updateMarkers() {
            console.log('Updating markers...');
            const currentCenter = map.getCenter();
            const currentZoom = map.getZoom();
            if (brunnenData) {
                const markers = brunnenData.features.map(feature => {
                    const coords = feature.geometry.coordinates;
                    const marker = new google.maps.Marker({
                        position: { lat: coords[1], lng: coords[0] },
                        icon: createIcon(markerSize, false)
                    });
                    marker.feature = feature; // Attach feature to marker for later use
                    marker.addListener('click', () => {
                        highlightBrunnen(marker, feature);
                    });
                    console.log('Adding marker:', marker);
                    allMarkers.push(marker);
                    return marker;
                });

                const markerCluster = new MarkerClusterer(map, markers, { imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m' });
                console.log('Clusters should now be visible on the map.');
            }
            map.setCenter(currentCenter);
            map.setZoom(currentZoom);
        }

        function highlightBrunnen(marker, feature) {
            console.log('Highlighting selected brunnen...');

            if (selectedMarker) {
                console.log('Deselecting previous marker:', selectedMarker);
                selectedMarker.setIcon(createIcon(markerSize, false));
                selectedMarker.setAnimation(null);
            }

            console.log('Selecting new marker:', marker);
            marker.setIcon(createIcon(markerSize, true));
            marker.setAnimation(google.maps.Animation.BOUNCE);
            selectedMarker = marker;

            if (userLocation) {
                const brunnenCoords = marker.getPosition();
                const userCoords = new google.maps.LatLng(userLocation.lat, userLocation.lng);
                const distance = google.maps.geometry.spherical.computeDistanceBetween(brunnenCoords, userCoords);
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'location': brunnenCoords }, function (results, status) {
                    if (status === 'OK' && results[0]) {
                        const address = results[0].formatted_address;
                        document.getElementById('distance').innerText = `${Math.round(distance)}m`;
                        document.getElementById('address').innerText = address;
                        const destinationUrl = `https://www.google.com/maps/dir/?api=1&destination=${brunnenCoords.lat()},${brunnenCoords.lng()}&travelmode=walking`;
                        document.getElementById('header-bar').onclick = function() {
                            if (alwaysAskNavigate) {
                                const confirmNavigate = confirm(`Sie haben den Trinkbrunnen bei ${address} ausgew√§hlt, ${Math.round(distance)} Meter entfernt. Navigieren?`);
                                if (confirmNavigate) {
                                    window.open(destinationUrl, '_blank');
                                }
                            } else {
                                window.open(destinationUrl, '_blank');
                            }
                        };
                        // Add polyline
                        if (polyline) {
                            polyline.setMap(null);
                        }
                        polyline = new google.maps.Polyline({
                            path: [userCoords, brunnenCoords],
                            geodesic: true,
                            strokeColor: '#003056',
                            strokeOpacity: 1.0,
                            strokeWeight: 5
                        });
                        polyline.setMap(map);
                    }
                });

                // Get walking distance
                fetch('/api/walking-distance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userLocation: userCoords.toJSON(), brunnenLocation: brunnenCoords.toJSON() })
                })
                .then(response => response.json())
                .then(data => {
                    const walkingDistance = data.walking_distance;
                    document.getElementById('walking-distance').innerText = `${Math.round(walkingDistance)}m`;
                    console.log(`Updated walking distance: ${walkingDistance}m`);
                })
                .catch(error => {
                    console.error('Error fetching walking distance:', error);
                });
            }
        }

        function startTrackingUserLocation() {
            if (navigator.geolocation) {
                userTrackingInterval = setInterval(() => {
                    navigator.geolocation.getCurrentPosition(position => {
                        console.log('Updating user location...');
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        if (userMarker) {
                            userMarker.setPosition(userLocation);
                        }
                        if (selectedMarker) {
                            highlightBrunnen(selectedMarker, selectedMarker.feature);
                        }
                    });
                }, 5000);
            }
        }

        document.getElementById('getLocation').addEventListener('click', () => {
            console.log('Focusing on user location...');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    console.log('User location obtained.');
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    if (userMarker) {
                        userMarker.setMap(null);
                    }
                    userMarker = new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: 'Ihr Standort',
                        icon: {
                            url: 'static/man.png',
                            scaledSize: new google.maps.Size(40, 40),
                            anchor: new google.maps.Point(20, 20)
                        }
                    });
                    map.setCenter(userLocation);
                    map.setZoom(16); // Zoom in on user location
                    document.getElementById('findClosest').disabled = false;
                    findClosestBrunnen(false);
                }, () => {
                    console.log('Error in geolocation.');
                    alert('Geolocation is not supported by this browser or access is denied.');
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        });

        document.getElementById('findClosest').addEventListener('click', () => findClosestBrunnen(true));

        function findClosestBrunnen(promptForNavigation, initialLoad = false) {
            console.log('Calculating closest brunnen...');
            fetch('/api/distance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ location: userLocation })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Closest brunnen data received.');
                const closestBrunnen = data.closest_brunnen;
                const distance = data.distance;
                const walkingDistance = data.walking_distance;
                const brunnenCoords = {
                    lat: closestBrunnen.geometry.coordinates[1],
                    lng: closestBrunnen.geometry.coordinates[0]
                };

                // Find the corresponding marker for the closest brunnen
                const closestMarker = allMarkers.find(marker => {
                    const pos = marker.getPosition();
                    return pos.lat() === brunnenCoords.lat && pos.lng() === brunnenCoords.lng;
                });

                if (selectedMarker) {
                    console.log('Deselecting previous marker:', selectedMarker);
                    selectedMarker.setIcon(createIcon(markerSize, false));
                    selectedMarker.setAnimation(null);
                }

                if (closestMarker) {
                    console.log('Closest brunnen located. removing default mapicon.png from it and replacing it with jumping mapicon_selected.png.');
                    closestMarker.setIcon(createIcon(markerSize, true));
                    closestMarker.setAnimation(google.maps.Animation.BOUNCE);
                    selectedMarker = closestMarker;
                }

                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'location': brunnenCoords }, function (results, status) {
                    if (status === 'OK' && results[0]) {
                        const address = results[0].formatted_address;
                        document.getElementById('distance').innerText = `${Math.round(distance)}m`;
                        document.getElementById('walking-distance').innerText = `${Math.round(walkingDistance)}m`;
                        document.getElementById('address').innerText = address;
                        const destinationUrl = `https://www.google.com/maps/dir/?api=1&destination=${brunnenCoords.lat},${brunnenCoords.lng}&travelmode=walking`;
                        document.getElementById('header-bar').onclick = function() {
                            if (alwaysAskNavigate) {
                                const confirmNavigate = confirm(`Der n√§chste Trinkbrunnen befindet sich bei ${address}, ${Math.round(distance)} Meter entfernt. Navigieren?`);
                                if (confirmNavigate) {
                                    window.open(destinationUrl, '_blank');
                                }
                            } else {
                                window.open(destinationUrl, '_blank');
                            }
                        };
                        if (promptForNavigation && alwaysAskNavigate) {
                            const confirmNavigate = confirm(`Der n√§chste Trinkbrunnen befindet sich bei ${address}, ${Math.round(distance)} Meter entfernt. Navigieren?`);
                            if (confirmNavigate) {
                                window.open(destinationUrl, '_blank');
                            }
                        }
                    }
                });

                // Add polyline
                const userCoords = new google.maps.LatLng(userLocation.lat, userLocation.lng);
                if (polyline) {
                    polyline.setMap(null);
                }
                polyline = new google.maps.Polyline({
                    path: [userCoords, new google.maps.LatLng(brunnenCoords.lat, brunnenCoords.lng)],
                    geodesic: true,
                    strokeColor: '#003056',
                    strokeOpacity: 1.0,
                    strokeWeight: 5
                });
                polyline.setMap(map);

                // Select the closest brunnen on initial load
                if (initialLoad) {
                    highlightBrunnen(selectedMarker, selectedMarker.feature);
                }
            })
            .catch(error => {
                console.error('Error fetching closest brunnen:', error);
            });
        }

        console.log('Window onload event.');
        window.onload = () => {
            initMap();
        };

        // Ensure dropdown stays open when interacting with form elements
        $(document).on('click', '.dropdown-menu', function (e) {
            e.stopPropagation();
        });
    </script>
</body>
</html>
